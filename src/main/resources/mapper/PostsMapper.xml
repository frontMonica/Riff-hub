<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.riffhub.mapper.PostsMapper">
    <insert id="add" parameterType="com.riffhub.pojo.Post" useGeneratedKeys="true" keyProperty="id">
        insert into posts(content, title, nickname,user_id, create_time, update_time)
        values (#{content}, #{title}, #{nickname},#{userId}, now(), now())
    </insert>

    <insert id="relatedTagsToPost" parameterType="java.util.List">
        INSERT INTO PostTags (tag_id,post_id)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.tagId},#{item.postId})
        </foreach>
    </insert>

    <insert id="reply" parameterType="com.riffhub.pojo.Reply">
        insert into replies(post_id, user_id, content, create_time)
        values (#{postId}, #{userId}, #{content}, now())
    </insert>

    <delete id="deleteReply" parameterType="com.riffhub.pojo.Reply">
        DELETE FROM replies
        WHERE id = #{id}
    </delete>
    <select id="findByReplyId" resultType="com.riffhub.pojo.Reply">
        SELECT * FROM replies WHERE id=#{id}
    </select>

    <select id="getPostList" parameterType="com.riffhub.type.GetPostListParams" resultType="com.riffhub.pojo.Post">
        SELECT * FROM Posts
        WHERE
            (#{title} IS NULL OR title LIKE CONCAT('%', #{title}, '%'))
          AND
            (#{userId} IS NULL OR user_id = #{userId})
            limit #{page},#{pageSize}
    </select>
    <select id="getAllPostList" parameterType="com.riffhub.type.GetPostListParams" resultType="com.riffhub.pojo.Post">
        SELECT * FROM Posts
        WHERE
            (#{title} IS NULL OR title LIKE CONCAT('%', #{title}, '%'))
          AND
            (#{userId} IS NULL OR user_id = #{userId})
    </select>

</mapper>